version: 0.7.{build}
image: Visual Studio 2017
clone_folder: c:\projects\lief

configuration: Release

#clone_depth: 3

platform:
- x86
- x64

init:
  - ps: $env:APPVEYOR_SAVE_CACHE_ON_ERROR = "true"
  # - echo %APPVEYOR_BUILD_FOLDER%
  # - ps: $blockRdp = $true;iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
#cache:
#  - rang_cpp_color-prefix -> CMakeLists.txt
#  - mbed_tls -> CMakeLists.txt
#  - libjson-prefix -> CMakeLists.txt
#  - easyloggingpp-prefix -> CMakeLists.txt
#  - tests\YAMLCPP -> tests\CMakeLists.txt
#  - tests\lief-samples -> tests\CMakeLists.txt
#  - tests\catch -> tests\CMakeLists.txt
#  - api\python\pybind11-prefix -> api\python\CMakeLists.txt

environment:
 CCACHE_DIR: "%APPVEYOR_BUILD_FOLDER%\\.ccache"
 LIEF_AUTOMATIC_BUILDS_KEY:
    secure: TT7SXISIifq2/tf02n2ATgPj+Ky4Cjl3Fg44BAfyI4yRa4i87UAQIx5EFeV63+Xv2rhcU7JcMgl+An7QBrV6ofuQ9jxbuw+Gd1GqcCrAIyY=
 LIEF_AUTOMATIC_BUILDS_IV:
    secure: /S6Vbt3vEisoC81siFbkqOXQeVnwxLZZPMYp1r79G7h+HFjLlWUZSidxxpsAgHNE
 matrix:
    # Python 2.7
    #- PYTHON_VERSION:   "2.7"
    #  PYTHON32_PATH:    "C:\\Python27"
    #  PYTHON32_INCLUDE: "C:\\Python27\\include"
    #  PYTHON32_BINARY:  "C:\\Python27\\python.exe"
    #  PYTHON32_LIBRARY: "C:\\Python27\\libs\\python27.lib"
    #  PYTHON64_PATH:    "C:\\Python27-x64"
    #  PYTHON64_INCLUDE: "C:\\Python27-x64\\include"
    #  PYTHON64_BINARY:  "C:\\Python27-x64\\python.exe"
    #  PYTHON64_LIBRARY: "C:\\Python27-x64\\libs\\python27.lib"


    # Python 3.5
    # - PYTHON_VERSION:   "3.5"
    #   PYTHON32_PATH:    "C:\\Python35"
    #   PYTHON32_INCLUDE: "C:\\Python35\\include"
    #   PYTHON32_BINARY:  "C:\\Python35\\python.exe"
    #   PYTHON32_LIBRARY: "C:\\Python35\\libs\\python35.lib"
    #   PYTHON64_PATH:    "C:\\Python35-x64"
    #   PYTHON64_INCLUDE: "C:\\Python35-x64\\include"
    #   PYTHON64_BINARY:  "C:\\Python35-x64\\python.exe"
    #   PYTHON64_LIBRARY: "C:\\Python35-x64\\libs\\python35.lib"


    # ## Python 3.6
    # - PYTHON_VERSION:   "3.6"
    #   PYTHON32_PATH:    "C:\\Python36"
    #   PYTHON32_INCLUDE: "C:\\Python36\\include"
    #   PYTHON32_BINARY:  "C:\\Python36\\python.exe"
    #   PYTHON32_LIBRARY: "C:\\Python36\\libs\\python36.lib"
    #   PYTHON64_PATH:    "C:\\Python36-x64"
    #   PYTHON64_INCLUDE: "C:\\Python36-x64\\include"
    #   PYTHON64_BINARY:  "C:\\Python36-x64\\python.exe"
    #   PYTHON64_LIBRARY: "C:\\Python36-x64\\libs\\python36.lib"

    # # Python 3.7
    # - PYTHON_VERSION:   "3.7"
    #   PYTHON32_PATH:    "C:\\Python37"
    #   PYTHON32_INCLUDE: "C:\\Python37\\include"
    #   PYTHON32_BINARY:  "C:\\Python37\\python.exe"
    #   PYTHON32_LIBRARY: "C:\\Python37\\libs\\python37.lib"
    #   PYTHON64_PATH:    "C:\\Python37-x64"
    #   PYTHON64_INCLUDE: "C:\\Python37-x64\\include"
    #   PYTHON64_BINARY:  "C:\\Python37-x64\\python.exe"
    #   PYTHON64_LIBRARY: "C:\\Python37-x64\\libs\\python37.lib"

    # Python 3.8
    - PYTHON_VERSION:   "3.8"
      PYTHON32_PATH:    "C:\\Python38"
      PYTHON32_INCLUDE: "C:\\Python38\\include"
      PYTHON32_BINARY:  "C:\\Python38\\python.exe"
      # PYTHON32_LIBRARY: "disabled"
      PYTHON64_PATH:    "C:\\Python38-x64"
      PYTHON64_INCLUDE: "C:\\Python38-x64\\include"
      PYTHON64_BINARY:  "C:\\Python38-x64\\python.exe"
      # PYTHON64_LIBRARY: "disabled"

matrix:
  fast_finish: true     # set this flag to immediately finish build once one of the jobs fails.

install:
  - ps: if ($env:PLATFORM -eq "x64") { $env:CMAKE_ARCH = "x64" }

  - ps: if ($env:PLATFORM -eq "x64") { $env:PYTHON_PATH    = $env:PYTHON64_PATH }
  - ps: if ($env:PLATFORM -eq "x64") { $env:PYTHON_INCLUDE = $env:PYTHON64_INCLUDE }
  - ps: if ($env:PLATFORM -eq "x64") { $env:PYTHON_BINARY  = $env:PYTHON64_BINARY }
  - ps: if ($env:PLATFORM -eq "x64") { $env:PYTHON_LIBRARY = $env:PYTHON64_LIBRARY }

  - ps: if ($env:PLATFORM -eq "x86") { $env:PYTHON_PATH    = $env:PYTHON32_PATH }
  - ps: if ($env:PLATFORM -eq "x86") { $env:PYTHON_INCLUDE = $env:PYTHON32_INCLUDE }
  - ps: if ($env:PLATFORM -eq "x86") { $env:PYTHON_BINARY  = $env:PYTHON32_BINARY }
  - ps: if ($env:PLATFORM -eq "x86") { $env:PYTHON_LIBRARY = $env:PYTHON32_LIBRARY }
  - set PATH=%PYTHON_PATH%;%PATH%

  # Upgrade pip
  - python.exe -m pip install --disable-pip-version-check --user --upgrade pip
  - python.exe -m pip install --user wheel mako
  - python.exe -m pip install --upgrade setuptools


build_script:
  - cd %APPVEYOR_BUILD_FOLDER%
  - set MSBuildLogger="C:\Program Files\AppVeyor\BuildAgent\Appveyor.MSBuildLogger.dll"
  - python.exe .\setup.py --sdk --lief-test bdist_wheel && exit 0 # Ignore warnings...

after_build:
  - bash ./.github/deploy.sh

artifacts:
  - path: 'dist\*.whl'
    name: python-wheel

  - path: 'build\*.zip'
    name: sdk

on_finish:
  - ps: $blockRdp = $true;iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
  - ECHO %APPVEYOR%
# CI - True if build runs in AppVeyor environment;
  - ECHO %CI%
# APPVEYOR_API_URL - AppVeyor Build Agent API URL;
  - ECHO %APPVEYOR_API_URL%
# APPVEYOR_ACCOUNT_NAME - account name;
  - ECHO %APPVEYOR_ACCOUNT_NAME%
# APPVEYOR_PROJECT_ID - AppVeyor unique project ID;
  - ECHO %APPVEYOR_PROJECT_ID%
# APPVEYOR_PROJECT_NAME - project name;
  - ECHO %APPVEYOR_PROJECT_NAME%
# APPVEYOR_PROJECT_SLUG - project slug (as seen in project details URL);
  - ECHO %APPVEYOR_PROJECT_SLUG%
# APPVEYOR_BUILD_FOLDER - path to clone directory;
  - ECHO %APPVEYOR_BUILD_FOLDER%
# APPVEYOR_BUILD_ID - AppVeyor unique build ID;
  - ECHO %APPVEYOR_BUILD_ID%
# APPVEYOR_BUILD_NUMBER - build number;
  - ECHO %APPVEYOR_BUILD_NUMBER%
# APPVEYOR_BUILD_VERSION - build version;
  - ECHO %APPVEYOR_BUILD_VERSION%
# APPVEYOR_PULL_REQUEST_NUMBER - GitHub Pull Request number;
  - ECHO %APPVEYOR_PULL_REQUEST_NUMBER%
# APPVEYOR_PULL_REQUEST_TITLE - GitHub Pull Request title
  - ECHO %APPVEYOR_PULL_REQUEST_TITLE%
# APPVEYOR_JOB_ID - AppVeyor unique job ID;
  - ECHO %APPVEYOR_JOB_ID%
# APPVEYOR_JOB_NAME - job name;
  - ECHO %APPVEYOR_JOB_NAME%
# APPVEYOR_REPO_PROVIDER - github, bitbucket, kiln, vso or gitlab;
  - ECHO %APPVEYOR_REPO_PROVIDER%
# APPVEYOR_REPO_SCM - git or mercurial;
  - ECHO %APPVEYOR_REPO_SCM%
# APPVEYOR_REPO_NAME - repository name in format owner-name/repo-name;
  - ECHO %APPVEYOR_REPO_NAME%
# APPVEYOR_REPO_BRANCH - build branch. For Pull Request commits it is base branch PR is merging into;
  - ECHO %APPVEYOR_REPO_BRANCH%
# APPVEYOR_REPO_TAG - true if build has started by pushed tag; otherwise false;
  - ECHO %APPVEYOR_REPO_TAG%
# APPVEYOR_REPO_TAG_NAME - contains tag name for builds started by tag; otherwise this variable is undefined;
  - ECHO %APPVEYOR_REPO_TAG_NAME%
# APPVEYOR_REPO_COMMIT - commit ID (SHA);
  - ECHO %APPVEYOR_REPO_COMMIT%
# APPVEYOR_REPO_COMMIT_AUTHOR - commit author’s name;
  - ECHO %APPVEYOR_REPO_COMMIT_AUTHOR%
# APPVEYOR_REPO_COMMIT_AUTHOR_EMAIL - commit author’s email address;
  - ECHO %APPVEYOR_REPO_COMMIT_AUTHOR_EMAIL%
# APPVEYOR_REPO_COMMIT_TIMESTAMP - commit date/time;
  - ECHO %APPVEYOR_REPO_COMMIT_TIMESTAMP%

cache:
    - .ccache

deploy:
  description: "LIEF version $(APPVEYOR_REPO_TAG_NAME)"
  provider: GitHub
  auth_token:
    secure: FU9CGrZ1lm0VDHUZg6zvTL4tidluDvRegVUTehCRo2xgiOv6NZePi7TdSy5CsOdG
  artifact: sdk;python-src;python-egg
  draft: false
  prerelease: false
  force_update: true
  on:
    appveyor_repo_tag: true # deploy on tag push only


